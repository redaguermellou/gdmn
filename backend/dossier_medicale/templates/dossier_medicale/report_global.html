{% extends 'base.html' %}

{% block content %}
<div class="dashboard-container">
    <div class="row align-items-center mb-5 animate-slide-down">
        <div class="col-md-6">
            <h2 class="fw-bold mb-1" style="color: var(--text-main);">
                Rapport Global Analystique <span class="wave">üìä</span>
            </h2>
            <p class="text-muted mb-0">Vue d'ensemble des dossiers m√©dicaux et prises en charge.</p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <button onclick="window.print()" class="btn btn-white shadow-sm hover-lift text-dark">
                <i class="fas fa-print me-2 text-primary"></i>Exporter / Imprimer
            </button>
        </div>
    </div>

    <!-- Section: Dossiers M√©dicaux -->
    <div class="mb-5">
        <h4 class="fw-bold mb-4 d-flex align-items-center text-primary">
            <i class="fas fa-folder-open me-3"></i>Dossiers M√©dicaux
        </h4>
        <div class="row g-4 mb-4 animate-slide-up">
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1">{{ dossier_stats.total }}</h3>
                    <p class="text-muted small mb-0">Total Dossiers</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-success">{{ dossier_stats.approved }}</h3>
                    <p class="text-muted small mb-0">Approuv√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-warning">{{ dossier_stats.pending }}</h3>
                    <p class="text-muted small mb-0">En attente</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-danger">{{ dossier_stats.rejected }}</h3>
                    <p class="text-muted small mb-0">Rejet√©s</p>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card-modern p-4">
                    <h6 class="fw-bold mb-4">R√©partition par Statut</h6>
                    <div style="height: 300px;">
                        <canvas id="dossierStatusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card-modern p-4">
                    <h6 class="fw-bold mb-4">Volume par Priorit√©</h6>
                    <div style="height: 300px;">
                        <canvas id="dossierPriorityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card-modern p-4">
                    <h6 class="fw-bold mb-4">Activit√© par D√©partement</h6>
                    <div style="height: 300px;">
                        <canvas id="dossierDeptChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table for Dossiers -->
        <div class="card-modern p-4 mt-4">
            <h6 class="fw-bold mb-3">R√©sum√© des Dossiers</h6>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Statut</th>
                            <th class="text-center">Nombre</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in dossier_table %}
                        <tr>
                            <td class="fw-medium">{{ row.label }}</td>
                            <td class="text-center">{{ row.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <hr class="my-5 opacity-25">

    <!-- Section: Prises en Charge -->
    <div class="mb-5">
        <h4 class="fw-bold mb-4 d-flex align-items-center text-accent">
            <i class="fas fa-file-invoice-dollar me-3"></i>Prises en Charge
        </h4>
        <div class="row g-4 mb-4 animate-slide-up">
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1">{{ pec_stats.total }}</h3>
                    <p class="text-muted small mb-0">Total Demandes</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-success">{{ pec_stats.approved }}</h3>
                    <p class="text-muted small mb-0">Approuv√©es</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-info">{{ pec_stats.total_cost|floatformat:2 }} ‚Ç¨</h3>
                    <p class="text-muted small mb-0">Co√ªt Total Estim√©</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-modern p-4 text-center border-0 shadow-sm">
                    <h3 class="fw-bold mb-1 text-danger">{{ pec_stats.rejected }}</h3>
                    <p class="text-muted small mb-0">Rejet√©es</p>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card-modern p-4">
                    <h6 class="fw-bold mb-4">Statut des PEC</h6>
                    <div style="height: 300px;">
                        <canvas id="pecStatusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card-modern p-4">
                    <h6 class="fw-bold mb-4">Type de Soins Sollicit√©s</h6>
                    <div style="height: 300px;">
                        <canvas id="pecTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table for PEC -->
        <div class="card-modern p-4 mt-4">
            <h6 class="fw-bold mb-3">R√©sum√© Financier des PEC</h6>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-accent">
                        <tr>
                            <th>Type de Soin</th>
                            <th class="text-center">Nombre</th>
                            <th class="text-end">Engagements (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in pec_table %}
                        <tr>
                            <td>{{ row.label }}</td>
                            <td class="text-center">{{ row.count }}</td>
                            <td class="text-end fw-bold text-dark">{{ row.cost|floatformat:2 }} ‚Ç¨</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <!-- Critical Dossiers Table -->
                <div class="card-modern p-4 border-danger border-start border-4 h-100">
                    <h6 class="fw-bold mb-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Dossiers
                        Critiques (Top 5)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>R√©f</th>
                                    <th>Patient</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in critical_dossiers %}
                                <tr>
                                    <td class="fw-bold">#{{ d.reference }}</td>
                                    <td>{{ d.employer.full_name }}</td>
                                    <td><span
                                            class="badge bg-{{ d.get_status_color }}-subtle text-{{ d.get_status_color }}">{{
                                            d.get_status_display }}</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">Aucun dossier critique.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Recent PEC Table -->
                <div class="card-modern p-4 border-primary border-start border-4 h-100">
                    <h6 class="fw-bold mb-3 text-primary"><i class="fas fa-history me-2"></i>PEC R√©centes (Top 5)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>R√©f</th>
                                    <th>Patient</th>
                                    <th>Co√ªt</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in recent_pecs %}
                                <tr>
                                    <td class="fw-bold">#{{ p.reference }}</td>
                                    <td>{{ p.patient.full_name }}</td>
                                    <td class="fw-bold">{{ p.estimated_cost }} ‚Ç¨</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">Aucune demande r√©cente.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data parsed from context
        const dossierStatus = JSON.parse('{{ chart_dossier_status|safe }}');
        const dossierPriority = JSON.parse('{{ chart_dossier_priority|safe }}');
        const dossierDept = JSON.parse('{{ chart_dossier_dept|safe }}');
        const pecStatus = JSON.parse('{{ chart_pec_status|safe }}');
        const pecType = JSON.parse('{{ chart_pec_type|safe }}');

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        };

        // 1. Dossier Status (Doughnut)
        new Chart(document.getElementById('dossierStatusChart'), {
            type: 'doughnut',
            data: {
                labels: dossierStatus.labels,
                datasets: [{
                    data: dossierStatus.data,
                    backgroundColor: dossierStatus.colors,
                    borderWidth: 0
                }]
            },
            options: { ...commonOptions, cutout: '70%' }
        });

        // 2. Dossier Priority (Bar)
        new Chart(document.getElementById('dossierPriorityChart'), {
            type: 'bar',
            data: {
                labels: dossierPriority.labels,
                datasets: [{
                    label: 'Nombre de dossiers',
                    data: dossierPriority.data,
                    backgroundColor: '#0ea5e9',
                    borderRadius: 8
                }]
            },
            options: {
                ...commonOptions,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Dossier Dept (Pie)
        new Chart(document.getElementById('dossierDeptChart'), {
            type: 'pie',
            data: {
                labels: dossierDept.labels,
                datasets: [{
                    data: dossierDept.data,
                    backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b', '#10b981']
                }]
            },
            options: commonOptions
        });

        // 4. PEC Status (Doughnut)
        new Chart(document.getElementById('pecStatusChart'), {
            type: 'doughnut',
            data: {
                labels: pecStatus.labels,
                datasets: [{
                    data: pecStatus.data,
                    backgroundColor: pecStatus.colors,
                    borderWidth: 0
                }]
            },
            options: { ...commonOptions, cutout: '70%' }
        });

        // 5. PEC Type (Polar Area)
        new Chart(document.getElementById('pecTypeChart'), {
            type: 'polarArea',
            data: {
                labels: pecType.labels,
                datasets: [{
                    data: pecType.data,
                    backgroundColor: ['#6366f1', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444']
                }]
            },
            options: commonOptions
        });
    });
</script>
{% endblock %}