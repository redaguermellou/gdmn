{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header and Create Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 fw-bold text-primary">
            <i class="fas fa-folder-open me-2"></i>
            Dossiers Médicaux
        </h4>
        <div>
            {% if request.user.role.name in 'AGENT,ADMIN,CONTROLLER' %}
            <a href="{% url 'create_dossier' %}" class="btn btn-primary btn-sm me-2 shadow-sm">
                <i class="fas fa-plus me-1"></i>Nouveau
            </a>
            {% endif %}
            {% if request.user.role.name in 'ADMIN,CONTROLLER' %}
            <a href="{% url 'audit_log' %}" class="btn btn-outline-secondary btn-sm shadow-sm">
                <i class="fas fa-history me-1"></i>Audit Log
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-4">
        <form method="get" action="{% url 'dossier_list' %}" class="d-flex">
            <div class="input-group input-group-sm" style="max-width: 340px;">
                <input type="text"
                       name="q"
                       class="form-control"
                       placeholder="Rechercher par référence ou employé"
                       value="{{ search_query|default:'' }}"
                       aria-label="Search">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-search"></i>
                </button>
                {% if search_query %}
                <a href="{% url 'dossier_list' %}" class="btn btn-outline-secondary btn-sm" title="Effacer la recherche">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Dossier Cards -->
    <div class="row g-4">
        {% for dossier in dossiers %}
        <div class="col-xl-4 col-lg-6 col-md-6">
            <div class="card dossier-card h-100 border-0 shadow-sm position-relative">
                
                <div class="card-header bg-white py-3 px-4 d-flex justify-content-between align-items-center border-0">
                    <h6 class="mb-0 text-truncate fw-semibold">
                        <i class="fas fa-file-medical text-primary me-1"></i>
                        #{{ dossier.reference }}
                    </h6>
                    <span class="badge rounded-pill 
                        {% if dossier.status == 'PENDING' %}bg-warning
                        {% elif dossier.status == 'APPROVED' %}bg-success
                        {% elif dossier.status == 'REJECTED' %}bg-danger
                        {% else %}bg-secondary{% endif %} py-2 px-3 fs-6">
                        {{ dossier.get_status_display|slice:":3" }}
                    </span>
                </div>
                <div class="card-body py-3 px-4">
                    <div class="dossier-info mb-2">
                        <div class="info-item small mb-2 d-flex justify-content-between">
                            <span class="text-muted"><i class="fas fa-user me-1"></i>Employé:</span>
                            <span class="text-end text-truncate fw-medium" style="max-width: 120px;">
                                {{ dossier.employer }}
                            </span>
                        </div>
                        <div class="info-item small mb-2 d-flex justify-content-between">
                            <span class="text-muted"><i class="fas fa-exclamation-circle me-1 text-warning"></i>Priorité:</span>
                            <span class="text-end text-truncate fw-medium" style="max-width: 60px;">{{ dossier.priority }}</span>
                        </div>
                        <div class="info-item small mb-2 d-flex justify-content-between">
                            <span class="text-muted"><i class="fas fa-calendar-alt me-1 text-info"></i>Date:</span>
                            <span class="fw-medium">{{ dossier.start_date|date:"d/m/y" }}</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="far fa-clock me-1"></i>
                            {{ dossier.created_at|date:"d/m/y" }}
                        </small>
                        <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
                            <div class="btn-group btn-group-sm dossier-action-group" role="group" aria-label="Actions">
                                <a href="{% url 'dossier_detail' dossier.id %}" class="btn btn-outline-primary dossier-action-btn" title="Voir le dossier">
                                    <i class="fas fa-eye fa-lg"></i>
                                </a>
                                {% if request.user.role.name in 'AGENT,ADMIN,CONTROLLER' %}
                                    {% if request.dossier_medicale.status != 'APPROVED' %}
                                        <a href="{% url 'edit_dossier' dossier.id %}" class="btn btn-outline-secondary dossier-action-btn" title="Modifier le dossier">
                                            <i class="fas fa-edit fa-lg"></i>
                                        </a>
                                    {% endif %}
                                <a href="{% url 'generate_report' dossier.id %}" class="btn btn-outline-info dossier-action-btn" title="Télécharger le rapport">
                                    <i class="fas fa-file-download fa-lg"></i>
                                </a>
                                <form method="post" action="{% url 'dossier_delete' dossier.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger dossier-action-btn" title="Supprimer le dossier"
                                        onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce dossier ?');">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Aucun dossier disponible</h5>
                    {% if request.GET.q %}
                    <p class="small">Aucun résultat pour "{{ request.GET.q }}"</p>
                    <a href="{% url 'dossier_list' %}" class="btn btn-sm btn-outline-primary mt-2">
                        Réinitialiser la recherche
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination with search preservation -->
    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a></li>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<style>
    .dossier-card {
        transition: all 0.2s ease;
        border-radius: 10px;
        font-size: 0.95rem;
        border: 1px solid #f0f0f0;
        background: #fafbfc;
        margin-bottom: 10px;
    }
    
    .dossier-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    
    .shadow-xs {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .info-item {
        border-bottom: 1px dashed rgba(0,0,0,0.05);
    }
    
    .badge {
        font-weight: 500;
        font-size: 0.7rem;
        min-width: 40px;
    }
    
    .btn-group-sm .btn {
        padding: 0.15rem 0.3rem;
        font-size: 0.7rem;
    }
    
    .text-truncate {
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dossier-card .btn-group .btn {
        margin-left: 2px;
        margin-right: 2px;
    }
    
    .dossier-card .btn-group form {
        display: inline;
        margin: 0;
        padding: 0;
    }
    .dossier-card .btn-group .btn {
        vertical-align: middle;
    }
    .dossier-card .btn-group .btn:focus {
        box-shadow: none;
    }
    .dossier-card .btn-group .btn-outline-danger {
        min-width: 32px;
    }
    
    .dossier-card .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .dossier-card .btn-outline-danger:hover {
        background: #dc3545;
        color: #fff;
    }
    
    .dossier-card .btn-outline-info {
        border-color: #0dcaf0;
        color: #0dcaf0;
    }
    
    .dossier-card .btn-outline-info:hover {
        background: #0dcaf0;
        color: #fff;
    }
</style>
{% endblock %}