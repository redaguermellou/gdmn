{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row justify-content-center animate-fade-up">
    <div class="col-lg-10 col-xl-9">
        <!-- Back Link -->
        <div class="mb-4">
            <a href="{% url 'dossier_list' %}" class="text-decoration-none text-muted small hover-primary fw-600">
                <i class="fas fa-arrow-left me-2"></i> Retour à mes dossiers
            </a>
        </div>

        <div class="card-modern mb-5 overflow-hidden">
            <div class="status-stripe bg-{{ dossier.get_status_color }}"></div>

            <div class="card-body p-5">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-5">
                    <div>
                        <span class="text-xs text-uppercase text-muted fw-800 letter-spacing-wide d-block mb-1">Détails
                            du Dossier</span>
                        <h2 class="fw-800 mb-1" style="color: var(--text-main);">#{{ dossier.reference }}</h2>
                        <div class="d-flex gap-3 text-sm text-muted">
                            <span><i class="far fa-calendar-alt me-1"></i> Créé le {{ dossier.created_at|date:"d M Y"
                                }}</span>
                            <span><i class="fas fa-building me-1"></i> {{ dossier.department }}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <span
                            class="badge rounded-pill px-4 py-2 bg-{{ dossier.get_status_color }}-subtle text-{{ dossier.get_status_color }} border border-{{ dossier.get_status_color }}-subtle mb-2 d-inline-block">
                            {{ dossier.get_status_display }}
                        </span>
                        {% if dossier.status == 'PENDING' %}
                        <p class="text-xs text-muted mb-0">Votre dossier est en cours de traitement</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="row g-5 mb-5">
                    <div class="col-md-7">
                        <h5 class="fw-800 mb-4" style="color: var(--text-main);">Résumé Médical</h5>
                        <div class="medical-text bg-soft p-4 rounded-lg border">
                            <h6 class="text-xs text-uppercase text-muted fw-800 mb-2">Diagnostic</h6>
                            <p class="mb-4">{{ dossier.diagnosis|default:"Non spécifié"|linebreaks }}</p>

                            <h6 class="text-xs text-uppercase text-muted fw-800 mb-2">Traitement</h6>
                            <p class="mb-0">{{ dossier.treatment_plan|default:"Non spécifié"|linebreaks }}</p>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h5 class="fw-800 mb-4" style="color: var(--text-main);">Équipe Médicale</h5>
                        <div class="p-4 border rounded-lg bg-soft h-100">
                            <div class="d-flex align-items-center mb-4">
                                <div class="icon-box bg-blue-soft text-primary me-3" style="width: 48px; height: 48px;">
                                    <i class="fas fa-user-md fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-800">{{ dossier.doctor }}</h6>
                                    <span class="text-xs text-muted">Médecin Référent</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="icon-box bg-warning-soft text-warning me-3"
                                    style="width: 48px; height: 48px;">
                                    <i class="fas fa-hospital fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-800">{{ dossier.department }}</h6>
                                    <span class="text-xs text-muted">Service de santé Newrest</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attachments Section -->
                <div class="attachments-section mt-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-800 mb-0" style="color: var(--text-main);">Documents & Justificatifs</h5>
                        <div class="d-flex gap-2">
                            <a href="{% url 'generate_report' dossier.id %}"
                                class="btn btn-sm btn-outline-primary px-4 rounded-pill fw-600">
                                <i class="fas fa-file-pdf me-2"></i> Rapport Complet
                            </a>
                        </div>
                    </div>

                    <div class="row g-3">
                        {% for document in documents %}
                        <div class="col-md-6 col-lg-4">
                            <div
                                class="document-item p-3 border rounded-lg d-flex align-items-center justify-content-between hover-lift bg-white">
                                <div class="d-flex align-items-center overflow-hidden">
                                    <div class="icon-box bg-light text-muted me-3"
                                        style="width: 40px; height: 40px; flex-shrink: 0;">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="overflow-hidden">
                                        <h6 class="mb-0 text-sm fw-600 text-truncate">{{
                                            document.nom_fichier|default:document.name }}</h6>
                                        <span class="text-xs text-muted">{{ document.taille_ko|default:document.size_kb
                                            }} KB</span>
                                    </div>
                                </div>
                                {% if document.chemin_storage %}
                                <a href="{{ document.chemin_storage.url }}"
                                    class="btn btn-sm btn-light rounded-circle ms-2" download>
                                    <i class="fas fa-download"></i>
                                </a>
                                {% elif document.file %}
                                <a href="{{ document.file.url }}" class="btn btn-sm btn-light rounded-circle ms-2"
                                    download>
                                    <i class="fas fa-download"></i>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5 bg-soft rounded-lg border-dashed">
                            <i class="fas fa-folder-open text-muted mb-3 d-block" style="font-size: 2rem;"></i>
                            <p class="text-muted small mb-0">Aucun document n'a été rattaché à ce dossier.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .fw-800 {
        font-weight: 800;
    }

    .fw-600 {
        font-weight: 600;
    }

    .letter-spacing-wide {
        letter-spacing: 0.05em;
    }

    .rounded-lg {
        border-radius: 12px;
    }

    .document-item {
        transition: var(--transition-base);
    }

    .document-item:hover {
        border-color: var(--primary) !important;
        background: #f0f9ff !important;
    }

    .medical-text p {
        color: var(--text-secondary);
        line-height: 1.8;
    }
</style>
{% endblock %}