{% extends 'base.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block content %}
<div class="row justify-content-center animate-fade-up">
    <div class="col-lg-10">
        <div class="card-modern overflow-hidden">
            <div class="card-header bg-white border-0 pt-5 pb-2 px-5 text-center">
                <div class="icon-box bg-blue-soft text-primary mx-auto mb-3" style="width: 50px; height: 50px;">
                    <i class="fas fa-file-medical fa-lg"></i>
                </div>
                <h3 class="fw-800 mb-1" style="color: var(--text-main);">{{ title }}</h3>
                <p class="text-muted">Veuillez remplir les informations ci-dessous pour créer un nouveau dossier.</p>
            </div>

            <div class="card-body p-5">

                <form method="post" enctype="multipart/form-data" id="dossierForm" novalidate class="needs-validation">
                    {% csrf_token %}

                    <div class="row g-4">
                        <!-- Left Column: Form Fields -->
                        <div class="col-lg-8">
                            <div class="section-group mb-5">
                                <h5 class="fw-bold mb-4 d-flex align-items-center">
                                    <span class="step-number me-2">1</span> Informations Générales
                                </h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-600">Employé</label>
                                        {{ form.employer }}
                                    </div>
                                    <div class="col-md-6" style="display: none;">
                                        <label class="form-label fw-600">Département</label>
                                        {{ form.department }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-600">Catégorie</label>
                                        {{ form.category }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-600">Médecin</label>
                                        {{ form.doctor }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-600">Priorité</label>
                                        {{ form.priority }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-600">Date</label>
                                        {{ form.start_date }}
                                    </div>
                                </div>
                            </div>

                            <div class="section-group mb-4">
                                <h5 class="fw-bold mb-4 d-flex align-items-center">
                                    <span class="step-number me-2">2</span> Détails Médicaux
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label fw-600">Diagnostic</label>
                                    {{ form.diagnosis }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-600">Plan de Traitement</label>
                                    {{ form.treatment_plan }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-600">Commentaires (Optionnel)</label>
                                    {{ form.comments }}
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Attachments & Info -->
                        <div class="col-lg-4">
                            <div class="sticky-top" style="top: 100px; z-index: 10;">
                                <div class="card-modern bg-soft p-4 border-0 mb-4">
                                    <h5 class="fw-bold mb-3 d-flex align-items-center">
                                        <i class="fas fa-paperclip text-primary me-2"></i> Pièces Jointes
                                    </h5>

                                    <div class="upload-zone p-4 text-center border-dashed rounded-lg mb-3"
                                        id="dropZone">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="small text-muted mb-0">Cliquez ou glissez vos fichiers ici</p>
                                        <input type="file" name="attachments" id="attachmentsInput" multiple
                                            class="d-none">
                                        <button type="button" class="btn btn-sm btn-light mt-2 fw-medium"
                                            onclick="document.getElementById('attachmentsInput').click()">
                                            Parcourir
                                        </button>
                                    </div>

                                    <div id="fileList" class="file-list">
                                        <!-- Files will be listed here -->
                                        <p class="text-center text-muted small my-3" id="noFilesMsg">Aucun fichier
                                            sélectionné</p>
                                    </div>
                                </div>

                                <div class="card-modern bg-primary text-white p-4 border-0">
                                    <h6 class="fw-800 mb-2">Besoin d'aide ?</h6>
                                    <p class="small opacity-75 mb-0">Assurez-vous de joindre tous les documents
                                        nécessaires pour validation.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-5 opacity-10">

                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'dossier_list' %}" class="btn btn-link text-muted text-decoration-none fw-600">
                            <i class="fas fa-times me-2"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-modern-primary px-5 py-3 rounded-pill shadow-lg"
                            id="submitBtn">
                            <i class="fas fa-check-circle me-2"></i> Créer le dossier
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Core visual styles are now handled by main.css -->


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('attachmentsInput');
        const fileList = document.getElementById('fileList');
        const noFilesMsg = document.getElementById('noFilesMsg');
        const dropZone = document.getElementById('dropZone');

        let selectedFiles = [];

        fileInput.addEventListener('change', function () {
            handleFiles(this.files);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(item => {
                dataTransfer.items.add(item.file);
            });
            fileInput.files = dataTransfer.files;
        }

        function handleFiles(files) {
            if (files.length > 0) {
                noFilesMsg.style.display = 'none';
                Array.from(files).forEach(file => {
                    const fileId = Date.now() + Math.random();
                    selectedFiles.push({ id: fileId, file: file });

                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                    <div class="d-flex align-items-center overflow-hidden">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        <span class="small text-truncate" style="max-width: 150px;">${file.name}</span>
                    </div>
                    <i class="fas fa-times-circle btn-remove-file" onclick="removeFile(${fileId}, this.parentElement)"></i>
                `;
                    fileList.appendChild(fileItem);
                });
                updateFileInput();
            }
        }

        window.removeFile = function (id, element) {
            selectedFiles = selectedFiles.filter(item => item.id !== id);
            element.remove();
            if (selectedFiles.length === 0) {
                noFilesMsg.style.display = 'block';
            }
            updateFileInput();
        };

        // Form submission enhancement
        const form = document.getElementById('dossierForm');
        form.addEventListener('submit', function () {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Création en cours...';
        });
    });
</script>
{% endblock %}