{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Dossiers M√©dicaux | Syst√®me M√©dical</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

</head>

<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{% url 'redirect_home' %}">
                <i class="fas fa-heartbeat"></i>
                <span>GDMN</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Main Navigation Links (Can be added here) -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dossier_list' %}active{% endif %}"
                            href="{% url 'dossier_list' %}">
                            <i class="fas fa-columns me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'pec' in request.path %}active{% endif %}" href="{% url 'pec_list' %}">
                            <i class="fas fa-file-invoice-dollar me-1"></i> Prises en Charge
                        </a>
                    </li>
                    {% if request.user.role.name in 'ADMIN,CONTROLLER' %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'global_report' %}active{% endif %}"
                            href="{% url 'global_report' %}">
                            <i class="fas fa-chart-pie me-1"></i> Rapport Global
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'audit_log' %}active{% endif %}"
                            href="{% url 'audit_log' %}">
                            <i class="fas fa-history me-1"></i> Journal d'audit
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <!-- Right-aligned user info -->
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if request.user.is_authenticated %}
                    <li class="nav-item dropdown user-dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="user-avatar">
                                {% if request.user.first_name %}
                                {{ request.user.first_name|first|upper }}{{ request.user.last_name|first|upper }}
                                {% else %}
                                {{ request.user.full_name|slice:":2"|upper }}
                                {% endif %}
                            </span>
                            <span class="d-none d-sm-inline user-name">{{ request.user.full_name }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="userDropdown">
                            <li>
                                <h6 class="dropdown-header">
                                    {{ request.user.role.get_name_display }}
                                </h6>
                            </li>
                            {% if request.user.is_staff or request.user.is_superuser %}
                            <!-- Checking typical Django admin flags, can also check specific roles -->
                            <li>
                                <a class="dropdown-item" href="/admin/" target="_blank">
                                    <i class="fas fa-cog"></i> Administration
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'logout' %}">
                                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="btn btn-primary" href="{% url 'login' %}">Connexion</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container">


            <main class="main-container">
                <!-- Global Messages -->
                {% if messages %}
                <div class="messages-container animate-fade-in mb-4">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show border-0 shadow-sm mb-3"
                        role="alert"
                        style="border-left: 4px solid var(--{% if message.tags == 'error' %}danger{% else %}{{ message.tags|default:'primary' }}{% endif %}) !important;">
                        <div class="d-flex align-items-center">
                            <i
                                class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-3"></i>
                            <div>{{ message }}</div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% block content %}
                <!-- Content will be injected here -->
                {% endblock %}
            </main>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="d-flex justify-content-center align-items-center">
                <i class="fas fa-shield-alt me-2"></i>
                <span>Syst√®me s√©curis√© de gestion des dossiers m√©dicaux - ¬© 2025</span>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchContainer = document.getElementById('searchContainer');
            const searchInput = document.getElementById('searchInput');

            // Expand on input focus


            // Mobile behavior - always show expanded on mobile
            function handleMobileView() {
                if (window.innerWidth < 768) {
                    searchContainer && searchContainer.classList.add('expanded');
                } else if (searchInput && searchInput.value === '') {
                    searchContainer && searchContainer.classList.remove('expanded');
                }
            }

            // Check on load and resize
            handleMobileView();
            window.addEventListener('resize', handleMobileView);

            // Auto-dismiss messages
            const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000); // 5 seconds
            });

            // --- Easter Egg: Konami Code ---
            const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
            let konamiIndex = 0;

            document.addEventListener('keydown', (e) => {
                if (e.key === konamiCode[konamiIndex]) {
                    konamiIndex++;
                    if (konamiIndex === konamiCode.length) {
                        triggerEasterEgg();
                        konamiIndex = 0;
                    }
                } else {
                    konamiIndex = 0;
                }
            });

            // --- Easter Egg: Logo Click ---
            let logoClicks = 0;
            const logos = document.querySelectorAll('.navbar-brand, .brand-logo img');
            logos.forEach(logo => {
                logo.addEventListener('click', (e) => {
                    logoClicks++;
                    if (logoClicks >= 5) {
                        e.preventDefault();
                        triggerEasterEgg();
                        logoClicks = 0;
                    }
                });
            });

            function triggerEasterEgg() {
                // Heart Shower
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.className = 'easter-egg-heart';
                        heart.innerHTML = ['‚ù§Ô∏è', 'ü©∫', 'üíä', 'üè•', 'üöë'][Math.floor(Math.random() * 5)];
                        heart.style.left = Math.random() * 100 + 'vw';
                        heart.style.animationDuration = (Math.random() * 2 + 1) + 's';
                        document.body.appendChild(heart);
                        setTimeout(() => heart.remove(), 3000);
                    }, i * 100);
                }

                // Spin the logo icon
                const logoIcon = document.querySelector('.navbar-brand i');
                if (logoIcon) {
                    logoIcon.classList.add('spin-logo');
                    setTimeout(() => logoIcon.classList.remove('spin-logo'), 5000);
                }

                // Party Mode (Rainbow effect)
                document.body.classList.add('party-mode');
                setTimeout(() => document.body.classList.remove('party-mode'), 8000);

                // Toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--primary);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 50px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-weight: 700;
                    animation: slideUp 0.5s ease-out;
                `;
                toast.innerHTML = 'ü©∫ Mode Super Docteur Activ√© ! ‚ù§Ô∏è';
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideDown 0.5s ease-in forwards';
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>